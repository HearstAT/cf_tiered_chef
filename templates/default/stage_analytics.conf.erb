# chef analytics nginx config.
#
# Generated by Chef

server {
server_name <%= node['cf_tiered_chef']['analytics']['stage_subdomain'] %>.<%= node['cf_tiered_chef']['prime_domain'] %> chef-analytics.<%= node['cf_tiered_chef']['prime_domain'] %>;
    listen 80 default;
    rewrite ^(.*) https://$server_name$1 permanent;
}

server {
  listen 443;
  server_name <%= node['cf_tiered_chef']['analytics']['stage_subdomain'] %>.<%= node['cf_tiered_chef']['prime_domain'] %>;

  ssl on;
  ssl_certificate <%= node['cf_tiered_chef']['s3']['dir'] %>/certs/chef.<%= node['cf_tiered_chef']['prime_domain'] %>.crt;
  ssl_certificate_key <%= node['cf_tiered_chef']['s3']['dir'] %>/certs/chef.<%= node['cf_tiered_chef']['prime_domain'] %>.key;
  ssl_dhparam /var/opt/opscode-analytics/ssl/ca/dhparams.pem;

  ssl_session_timeout 5m;

  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA;
  ssl_prefer_server_ciphers on;

  client_max_body_size 250m;

  access_log /var/log/opscode-analytics/nginx/analytics.access.log opscode;
  error_log /var/log/opscode-analytics/nginx/analytics.error.log;

  add_header "X-UA-Compatible" "IE=Edge";

  proxy_set_header        Host            $host:$server_port;
  proxy_set_header        X-Real-IP       $remote_addr;
  proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header        X-Forwarded-Proto https;
  proxy_pass_request_headers on;
  proxy_connect_timeout   300;
  proxy_send_timeout      300;
  proxy_read_timeout      300;

  root /opt/opscode-analytics/embedded/service/actions_web;
  index  index.html;



  location ~ "^/docs$" {
    #access_log off;
    add_header Cache-Control "public";
    root /opt/opscode-analytics/embedded;
  }

  location ~ "^/docs/.*$" {
    #access_log off;
    add_header Cache-Control "public";
    root /opt/opscode-analytics/embedded;
  }

  location ~ "^/authentication-configuration$" {
    #access_log off;
    add_header Cache-Control "public";
    root /var/opt/opscode-analytics/actions_web;
  }

  location ~ "^/organizations/[a-z0-9\-_]+?/(aliases|rules)/.*$" {
      proxy_redirect https://notifier_config /;
      proxy_pass https://notifier_config;
  }

  location ~ "^/organizations/[a-z0-9\-_]+?/(aliases|rules)" {
      proxy_redirect https://notifier_config /;
      proxy_pass https://notifier_config;
  }

  location /messages {
      proxy_pass https://actions_messages;
  }

  location / {
    try_files $uri $uri/ @proxy;
  }

  location @proxy {
    proxy_pass http://actions;
  }

  location /v2 {
    root /opt/opscode-analytics/embedded/service/actions_web_react;
  }
}
